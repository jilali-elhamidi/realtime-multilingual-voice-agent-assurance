import logging
import uuid
from chromadb import PersistentClient
from sentence_transformers import SentenceTransformer

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("ingest")

def ingest_optimized():
    # 1. ุชุญููู ุงูููุฏูู
    logger.info("๐ Loading embedding model...")
    model = SentenceTransformer("sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2")

    # 2. ุงูุจูุงูุงุช ููุณูุฉ ุจุฏูุฉ (Chunks)
    # ูููุง ุจูุณุฎ ุงููุตูุต ูู ูููุงุชู ูุชูุณูููุง ูููุฑุงุช ููุทููุฉ
    documents = [
        # === AUTO (ุณูุงุฑุงุช) ===
        "ุงูุฅุทุงุฑ ุงูุนุงู ูุนูุฏ ุงูุชุฃููู: ุนูุฏ ุงูุชุฃููู ูู ุงูุชุฒุงู ูุงูููู ุจููู ูุจูู ุงูุดุฑูุฉ. ุงูุดุฑูุฉ ุชุนูุถ ุงูุฎุณุงุฆุฑ (ูุณูุฏุฉุ ุณุฑูุฉุ ุญุฑูู) ุญุณุจ ุงูุถูุงูุงุช. ุงููุคูู ูู ูุฌุจ ุฃู ูููู ุตุฑูุญุงู ููุญุชุฑู ุงูุฅุฌุฑุงุกุงุช.",
        "ุฅุฌุฑุงุกุงุช ููุฑูุฉ ุนูุฏ ูููุน ุญุงุฏุซุฉ ุณูุฑ: 1. ููู ุงูุณูุงุฑุฉ ูู ููุงู ุขูู. 2. ุดุนู ุฃุถูุงุก ุงูุชุญุฐูุฑ (4 clignotants). 3. ุญุท ูุซูุซ ุงูุชูุจูู. 4. ุชุฌูุจ ุงููุฒุงุน ูุงููุถุฑุฉ ุงูุฒุงูุฏุฉ.",
        "ุงูุฅุณุนุงู ูู ุญุงุฏุซ ุงูุณูุฑ: ููุง ูุงูู ุฌุฑุญูุ ุนูุท ููุฅุณุนุงู ูุงูุดุฑุทุฉ/ุงูุฏุฑู ููุฑุงู. ููููุน ุชุญุฑูู ุงููุตุงุจ ุฅูุง ูู ุญุงูุฉ ุงูุฎุทุฑ (ูุซู ุงูุนุงููุฉ).",
        "ุงููุฑู ุจูู ุงููุนุงููุฉ ุงููุฏูุฉ ูุงููุญุถุฑ: ุงููุนุงููุฉ ุงููุฏูุฉ (Constat) ุตุงูุญุฉ ููุท ููุฃุถุฑุงุฑ ุงููุงุฏูุฉ. ุฅุฐุง ูุงูู ุฌุฑุญู (ุฃุถุฑุงุฑ ุฌุณุฏูุฉ) ุถุฑูุฑู ูู ูุญุถุฑ ุงูุดุฑุทุฉ (PV).",
        "ุทุฑููุฉ ุชุนุจุฆุฉ ุงููุนุงููุฉ ุงููุฏูุฉ (Constat): ูุซููุฉ ูุง ุฑุฌุนุฉ ูููุง. ุชุฃูุฏ ูู ุงูุชุงุฑูุฎ ูุงูููุงู. ุงุฑุณู ุงููุฑููู (Croquis) ูุฒูุงู ูุญุฏุฏ ููุทุฉ ุงูุงุตุทุฏุงู. ุนูุฑ ุงูุฎุงูุงุช (Cases) ุจู X ุจุฏูุฉ ูุฃููุง ุชุญุฏุฏ ุงููุณุคูููุฉ.",
        "ุขุฌุงู ุงูุชุตุฑูุญ ุจุญุงุฏุซ ุงูุณูุงุฑุฉ: ุนูุฏู 5 ุฃูุงู ูู ุงูุญุงุฏุซ ุงูุนุงุฏู. ุนูุฏู 24 ุฅูู 48 ุณุงุนุฉ ูู ุงูุณุฑูุฉ (ูุน ุดูุงูุฉ ุงูุดุฑุทุฉ). ุงูุชุฃุฎูุฑ ุจูุง ุนุฐุฑ ูุณุจุจ ุณููุท ุงูุถูุงู.",
        "ุงูุฎุจุฑุฉ (Expertise) ูุงูุชุนููุถ: ุงูุดุฑูุฉ ุชุนูู ุฎุจูุฑ ูุชูููู ุงูุฃุถุฑุงุฑ. ููููู ุทูุจ ุฎุจุฑุฉ ูุถุงุฏุฉ. ุฅุฐุง ุงูุฅุตูุงุญ ุฃุบูู ูู ุงูุณูุงุฑุฉุ ุชุณูู (รpave) ูุชุนูุถ ูููุชูุง.",
        "ุญุณุงุจ ุงููุณุคูููุฉ ูุงูุชุนููุถ: ูุณุคูููุฉ 0% = ุชุนููุถ 100%. ูุณุคูููุฉ 50% = ุชุนููุถ 50%. ูุณุคูููุฉ 100% = ูุง ุชุนููุถ ุฅูุง ุจุถูุงูุฉ (Tierce) ูุน ุฎุตู (Franchise).",

        # === HABITATION (ุณูู) ===
        "ุชุฃููู ุงูุณูู (Multirisque): ูุญูู ุงูุฌุฏุฑุงู ูุงูุฃุซุงุซ ูู ุงูุญุฑููุ ุงููุงุกุ ุงูุณุฑูุฉุ ุชูุณูุฑ ุงูุฒุฌุงุฌุ ูุงููุณุคูููุฉ ุงููุฏููุฉ (ุถุฑุฑ ููุฌูุฑุงู).",
        "ุฅุฌุฑุงุกุงุช ุงุณุชุนุฌุงููุฉ ูู ุงูุณูู: ูู ุชุณุฑุจ ุงููุงุก: ุงูุทุน ุงููุงุก ููุดู ุงูููุงู. ูู ุงูุญุฑูู: ุณูุงูุฉ ุงููุงุณ ุฃููุงู ุซู ุณุฏ ุงูููุงูุฐ. ูู ุงูุณุฑูุฉ: ูุง ุชููุณ ุดูุฆุงู ูุงูุชุธุฑ ุงูุดุฑุทุฉ ูุฑูุน ุงูุจุตูุงุช.",
        "ูุงุนุฏุฉ ุงูุญูุงุธ ุนูู ุงูุฃุฏูุฉ (ุณูู): ููููุน ุงูุฅุตูุงุญ ุงูููุงุฆู ูุจู ุฒูุงุฑุฉ ุงูุฎุจูุฑ. ูุณููุญ ููุท ุจุงูุฅุตูุงุญ ุงููุคูุช ูููู ุงูุถุฑุฑ. ุฎุจู ุงูุฃุดูุงุก ุงููุชุถุฑุฑุฉ ูุฏููู.",
        "ุฅุซุจุงุช ุงูููุชููุงุช (ุณูู): ุฌูุฒ ุงูููุงุชูุฑ ุงูุฃุตููุฉุ ุงูุตูุฑ ุงููุฏููุฉุ ูุดูุงุฏุงุช ุงูุถูุงู. ุงูุดุฑูุฉ ุชุทุจู ุงูุชูุงุฏู (Vรฉtustรฉ) ูุนูู ูุง ุชุนูุถ ุจุซูู ุงูุฌุฏูุฏ.",
        
        # === PROCEDURE (ูุณุงุทุฑ) ===
        "ุทุฑู ุงูุชุตุฑูุญ ุจุงูุญุงุฏุซ: ูููู ุนุจุฑ: 1. ุงูููุงูุฉ (ุงููุณูุท). 2. ุงูุชุทุจูู ุงูุฅููุชุฑููู/ุงููููุน. 3. ูุฑูุฒ ุงูุงุชุตุงู (ูููุณุงุนุฏุฉ). 4. ุงูุจุฑูุฏ ุงููุถููู (ูู ุญุงูุฉ ุงููุฒุงุน).",
        "ุงููุนูููุงุช ุงูุถุฑูุฑูุฉ ููุชุตุฑูุญ: ุฑูู ุงูุจูููุตุฉุ ุงูุฒูุงู ูุงูููุงูุ ูุตู ุฏููู ููุญุงุฏุซุ ุฌุฑุฏ ุงูุฎุณุงุฆุฑุ ููุนูููุงุช ุงูุทุฑู ุงูุขุฎุฑ ูุงูุดููุฏ.",
        "ุณููุท ุงูุญู (Dรฉchรฉance): ุงูุชุฃุฎูุฑ ูู ุงูุชุตุฑูุญ ูุฏ ูุณูุท ุญูู ูู ุงูุชุนููุถ ุฅุฐุง ุชุณุจุจ ุจุถุฑุฑ ููุดุฑูุฉุ ุฅูุง ูู ุญุงูุฉ ุงูููุฉ ุงููุงูุฑุฉ (ูุซู ุงูุบูุจูุจุฉ).",
        "ุงูุชูุงุฏู (Prescription): ุชุณูุท ุฌููุน ุฏุนุงูู ุงูุชุฃููู ุจูุฑูุฑ ุณูุชูู ูู ุชุงุฑูุฎ ุงูุญุงุฏุซ."
    ]

    # ุชุตููู ุฏููู ูุณุงุนุฏ ุงูููุฏูู ุนูู ุงูููู
    metadatas = [
        {"category": "sinistre", "topic": "auto", "subtopic": "general"},
        {"category": "sinistre", "topic": "auto", "subtopic": "urgence"},
        {"category": "sinistre", "topic": "auto", "subtopic": "blessure"},
        {"category": "sinistre", "topic": "auto", "subtopic": "constat_vs_pv"},
        {"category": "sinistre", "topic": "auto", "subtopic": "remplissage_constat"},
        {"category": "sinistre", "topic": "auto", "subtopic": "delais"},
        {"category": "sinistre", "topic": "auto", "subtopic": "expertise"},
        {"category": "sinistre", "topic": "auto", "subtopic": "responsabilite"},
        
        {"category": "sinistre", "topic": "habitation", "subtopic": "general"},
        {"category": "sinistre", "topic": "habitation", "subtopic": "urgence"},
        {"category": "sinistre", "topic": "habitation", "subtopic": "Preuve"},
        {"category": "sinistre", "topic": "habitation", "subtopic": "justificatifs"},

        {"category": "sinistre", "topic": "procedure", "subtopic": "canaux"},
        {"category": "sinistre", "topic": "procedure", "subtopic": "infos"},
        {"category": "sinistre", "topic": "procedure", "subtopic": "decheance"},
        {"category": "sinistre", "topic": "procedure", "subtopic": "prescription"},
    ]

    ids = [str(uuid.uuid4()) for _ in documents]

    # 3. ุงูุงุชุตุงู ูุงูุญูุธ
    client = PersistentClient(path="./chroma_insurance_db")
    
    # ุชูุธูู ุงููุฏูู ูุถูุงู ุงูุฏูุฉ
    try:
        client.delete_collection("insurance_claims_qa")
    except:
        pass
        
    collection = client.get_or_create_collection(name="insurance_claims_qa")

    logger.info("โณ Generating embeddings...")
    embeddings = model.encode(documents).tolist()
    
    collection.add(documents=documents, embeddings=embeddings, metadatas=metadatas, ids=ids)
    logger.info(f"โ Indexed {len(documents)} high-quality chunks.")

if __name__ == "__main__":
    ingest_optimized()